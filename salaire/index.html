<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة رواتب المعلمين</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root {
            --primary-color: #1a4d2e;
            --primary-light: #4a785e;
            --secondary-color: #f5f5dc;
            --accent-color: #d4af37;
            --accent-dark: #b38f2a;
            --text-color: #333;
            --light-bg: #f9f9f7;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --salary-color: #2e7d32;
            --deduction-color: #c62828;
            --bonus-color: #0277bd;
            --budget-color: #6a1b9a;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 1.5rem;
            text-align: center;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }

        .header::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="rgba(255,255,255,0.1)"><path d="M30,10L50,30L70,10L90,30L70,50L90,70L70,90L50,70L30,90L10,70L30,50L10,30L30,10Z"/></svg>');
            opacity: 0.2;
        }

        .header h1 {
            margin: 0;
            font-size: 1.8rem;
            position: relative;
            z-index: 1;
        }

        .header p {
            margin: 0.5rem 0 0;
            opacity: 0.9;
            font-size: 1rem;
            position: relative;
            z-index: 1;
        }

        .info-icon {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: var(--accent-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            width: 80%;
            max-width: 500px;
            text-align: center;
        }

        .close-modal {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            cursor: pointer;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 25px;
        }

        .card-title {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--secondary-color);
            font-size: 1.3rem;
        }

        .salary-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 1.5rem;
        }

        .salary-input-group {
            margin-bottom: 1.5rem;
        }

        .salary-input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .salary-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .salary-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 77, 46, 0.2);
        }

        .budget-info {
            background-color: #f3e5f5;
            border: 1px solid #d1c4e9;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .budget-item {
            text-align: center;
            padding: 10px;
        }

        .budget-item h4 {
            margin-top: 0;
            color: var(--budget-color);
        }

        .budget-item .amount {
            font-size: 1.3rem;
            font-weight: bold;
        }

        .salary-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .salary-summary-item {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            text-align: center;
        }

        .salary-summary-item h4 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .salary-summary-item .amount {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .salary-base {
            color: var(--salary-color);
        }

        .salary-deductions {
            color: var(--deduction-color);
        }

        .salary-bonuses {
            color: var(--bonus-color);
        }

        .salary-net {
            color: var(--primary-color);
            font-size: 1.8rem !important;
        }

        .deductions-list, .bonuses-list {
            margin-top: 15px;
        }

        .deduction-item, .bonus-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .deduction-item:last-child, .bonus-item:last-child {
            border-bottom: none;
        }

        .add-item-btn {
            background-color: var(--primary-light);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
            font-family: 'Cairo', sans-serif;
        }

        .add-item-btn:hover {
            background-color: var(--primary-color);
        }

        .remove-item-btn {
            background-color: #f44336;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        button, .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover, .btn:hover {
            background-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-accent {
            background-color: var(--accent-color);
        }

        .btn-accent:hover {
            background-color: var(--accent-dark);
        }

        .pay-all-btn {
            background-color: #6a1b9a;
        }

        .pay-all-btn:hover {
            background-color: #5a0a8a;
        }

        .message {
            padding: 15px;
            margin: 15px 0;
            border-radius: var(--border-radius);
            display: none;
            font-weight: 600;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .hidden {
            display: none !important;
        }

        .financial-report {
            margin-top: 30px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
        }

        .report-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .report-controls select, 
        .report-controls input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: 'Cairo', sans-serif;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .report-table th, 
        .report-table td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        .report-table th {
            background-color: var(--primary-light);
            color: white;
        }

        .report-table tr:hover {
            background-color: #f5f5f5;
        }

        .total-row {
            font-weight: bold;
            background-color: var(--secondary-color);
        }

        .search-box {
            flex-grow: 1;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px 0;
            color: #6c757d;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }

        /* نافذة تأكيد دفع جميع الرواتب */
        .confirm-pay-all-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .confirm-pay-all-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .confirm-pay-all-content h3 {
            color: var(--primary-color);
            margin-top: 0;
            text-align: center;
        }

        .teachers-list-container {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
        }

        .teacher-pay-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }

        .teacher-pay-item:last-child {
            border-bottom: none;
        }

        .teacher-pay-item input[type="checkbox"] {
            margin-left: 10px;
        }

        .teacher-pay-details {
            flex-grow: 1;
        }

        .teacher-pay-salary {
            font-weight: bold;
            color: var(--primary-color);
        }

        .confirm-pay-all-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        /* نافذة إدارة الميزانية */
        .budget-management-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .budget-management-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .budget-management-content h3 {
            color: var(--primary-color);
            margin-top: 0;
            text-align: center;
        }

        .budget-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 1.5rem;
        }

        .budget-history {
            margin-top: 30px;
            border-top: 2px solid var(--secondary-color);
            padding-top: 20px;
        }

        .budget-history h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .budget-history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .budget-history-table th, 
        .budget-history-table td {
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        .budget-history-table th {
            background-color: var(--primary-light);
            color: white;
        }

        /* زر التقرير المالي الجانبي */
        .report-side-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background-color: var(--accent-color);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .report-side-btn:hover {
            transform: scale(1.1);
            background-color: var(--accent-dark);
        }

        /* نافذة طباعة التقارير */
        .print-report-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .print-report-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .print-report-content h3 {
            color: var(--primary-color);
            margin-top: 0;
            text-align: center;
        }

        .print-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .print-option {
            background-color: var(--light-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .print-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
        }

        .print-option i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .print-option h4 {
            margin: 0;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .salary-form-grid, .budget-info, .salary-summary {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .button-group button {
                width: 100%;
            }
            
            .report-controls {
                flex-direction: column;
            }

            .confirm-pay-all-buttons {
                flex-direction: column;
            }

            .report-side-btn {
                bottom: 20px;
                left: 20px;
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- أيقونة المعلومات -->
        <div class="info-icon" id="infoIcon">
            <i class="fas fa-info"></i>
        </div>

        <!-- نافذة منبثقة للمعلومات -->
        <div class="modal" id="infoModal">
            <div class="modal-content">
                <h3>تعليمات التعديل على الرواتب</h3>
                <p>للتعديل في رواتب المعلمين أو إضافة معلم جديد، يمكنك التعديل على ملف Google Sheets التالي:</p>
                <p><a href="https://docs.google.com/spreadsheets/d/1sVPEWOzXBXa7ALsswi5jE2Wh-t5b5KZ8zCCHgxzz7bw/edit?gid=0#gid=0" target="_blank">فتح ملف المعلمين</a></p>
                <button class="close-modal" id="closeModal">حسناً</button>
            </div>
        </div>

        <!-- نافذة تأكيد دفع جميع الرواتب -->
        <div class="confirm-pay-all-modal" id="confirmPayAllModal">
            <div class="confirm-pay-all-content">
                <h3>تأكيد دفع رواتب المعلمين</h3>
                <p>الرجاء تحديد المعلمين الذين تريد دفع رواتبهم لهذا الشهر:</p>
                
                <div class="teachers-list-container" id="teachersPayList">
                    <!-- سيتم تعبئتها ديناميكياً -->
                </div>
                
                <div class="confirm-pay-all-buttons">
                    <button id="confirmPayAllBtn" class="btn pay-all-btn">
                        <i class="fas fa-check"></i> دفع الرواتب المحددة
                    </button>
                    <button id="cancelPayAllBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
        </div>

        <!-- نافذة إدارة الميزانية -->
        <div class="budget-management-modal" id="budgetManagementModal">
            <div class="budget-management-content">
                <h3>إدارة الميزانية الإجمالية</h3>
                
                <div class="budget-form-grid">
                    <div class="salary-input-group">
                        <label for="totalBudget">الميزانية الإجمالية للسنة الحالية (د.ج)</label>
                        <input type="number" id="totalBudget" class="salary-input" placeholder="سيتم حسابها تلقائياً" readonly>
                    </div>
                    
                    <div class="salary-input-group">
                        <label for="transferFromLastYear">تحويل من السنة السابقة (د.ج)</label>
                        <input type="number" id="transferFromLastYear" class="salary-input" placeholder="أدخل المبلغ المحول">
                    </div>
                    
                    <div class="salary-input-group">
                        <label for="donationsAmount">تبرعات المساهمين (د.ج)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="donationsAmount" class="salary-input" placeholder="المبلغ">
                            <input type="text" id="donorName" class="salary-input" placeholder="اسم المتبرع">
                        </div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button id="saveBudgetChangesBtn" class="btn">
                        <i class="fas fa-save"></i> حفظ التعديلات
                    </button>
                    <button id="cancelBudgetChangesBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
                
                <div class="budget-history">
                    <h4>سجل تعديلات الميزانية</h4>
                    <div class="table-responsive">
                        <table class="budget-history-table">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>النوع</th>
                                    <th>المبلغ (د.ج)</th>
                                    <th>الملاحظات</th>
                                </tr>
                            </thead>
                            <tbody id="budgetHistoryBody">
                                <!-- سيتم ملؤها ديناميكياً -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- نافذة طباعة التقارير -->
        <div class="print-report-modal" id="printReportModal">
            <div class="print-report-content">
                <h3>طباعة التقارير المالية</h3>
                
                <div class="print-options">
                    <div class="print-option" id="printMonthlyReport">
                        <i class="fas fa-calendar-alt"></i>
                        <h4>تقرير شهري</h4>
                        <p>طباعة تقرير لشهر معين</p>
                    </div>
                    
                    <div class="print-option" id="printYearlyReport">
                        <i class="fas fa-calendar"></i>
                        <h4>تقرير سنوي</h4>
                        <p>طباعة تقرير لسنة معينة</p>
                    </div>
                    
                    <div class="print-option" id="printCustomReport">
                        <i class="fas fa-filter"></i>
                        <h4>تقرير مخصص</h4>
                        <p>طباعة تقرير حسب الفلترة الحالية</p>
                    </div>
                </div>
                
                <div class="button-group">
                    <button id="closePrintModalBtn" class="btn btn-secondary">
                        <i class="fas fa-times"></i> إغلاق
                    </button>
                </div>
            </div>
        </div>

        <!-- زر التقرير المالي الجانبي -->
        <div class="report-side-btn" id="reportSideBtn">
            <i class="fas fa-file-invoice-dollar"></i>
        </div>

        <div class="header">
            <h1>نظام إدارة رواتب المعلمين</h1>
            <p>نظام متكامل لحساب وإدارة رواتب المعلمين بالدينار الجزائري</p>
        </div>

        <div class="card">
            <h2 class="card-title">بيانات الراتب</h2>
            
            <div class="budget-info">
                <div class="budget-item">
                    <h4>الرواتب المدفوعة هذا الشهر</h4>
                    <div class="amount" id="currentMonthSalaries">0 د.ج</div>
                </div>
                <div class="budget-item">
                    <h4>الرواتب المدفوعة خلال الموسم</h4>
                    <div class="amount" id="seasonSalaries">0 د.ج</div>
                </div>
                <div class="budget-item">
                    <h4>المتبقي في الميزانية</h4>
                    <div class="amount" id="remainingBudget">0 د.ج</div>
                </div>
                <div class="budget-item">
                    <h4>المصروفات الأخرى</h4>
                    <div class="amount" id="otherExpenses">0 د.ج</div>
                </div>
            </div>
            
            <div class="salary-form-grid">
                <div class="form-group">
                    <label for="teacherSelect">اختر المعلم</label>
                    <div class="input-icon">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <select id="teacherSelect" class="salary-input" required>
                            <option value="">-- اختر المعلم --</option>
                            <option value="all">جميع المعلمين</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="monthSelect">الشهر</label>
                    <div class="input-icon">
                        <i class="fas fa-calendar-alt"></i>
                        <select id="monthSelect" class="salary-input" required>
                            <option value="">-- اختر الشهر --</option>
                            <option value="1">جانفي</option>
                            <option value="2">فيفري</option>
                            <option value="3">مارس</option>
                            <option value="4">أفريل</option>
                            <option value="5">ماي</option>
                            <option value="6">جوان</option>
                            <option value="7">جويلية</option>
                            <option value="8">أوت</option>
                            <option value="9">سبتمبر</option>
                            <option value="10">أكتوبر</option>
                            <option value="11">نوفمبر</option>
                            <option value="12">ديسمبر</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="yearSelect">السنة</label>
                    <div class="input-icon">
                        <i class="fas fa-calendar"></i>
                        <input type="number" id="yearSelect" class="salary-input" min="2020" max="2030" required>
                    </div>
                </div>
            </div>

            <div class="salary-input-group">
                <label for="baseSalary">الراتب الأساسي (د.ج)</label>
                <div class="input-icon">
                    <i class="fas fa-money-bill-wave"></i>
                    <input type="number" id="baseSalary" class="salary-input" placeholder="أدخل الراتب الأساسي" required>
                </div>
            </div>

            <div class="deductions-list">
                <h4>الخصومات (د.ج)</h4>
                <div id="deductionsContainer">
                    <!-- سيتم إضافة الخصومات ديناميكياً -->
                </div>
                <button type="button" class="add-item-btn" id="addDeductionBtn">
                    <i class="fas fa-plus"></i> إضافة خصم
                </button>
            </div>

            <div class="bonuses-list">
                <h4>العلاوات والمكافآت (د.ج)</h4>
                <div id="bonusesContainer">
                    <!-- سيتم إضافة العلاوات ديناميكياً -->
                </div>
                <button type="button" class="add-item-btn" id="addBonusBtn">
                    <i class="fas fa-plus"></i> إضافة علاوة
                </button>
            </div>

            <div class="salary-summary">
                <div class="salary-summary-item">
                    <h4>الراتب الأساسي</h4>
                    <div class="amount salary-base" id="baseSalaryDisplay">0 د.ج</div>
                </div>
                <div class="salary-summary-item">
                    <h4>إجمالي الخصومات</h4>
                    <div class="amount salary-deductions" id="totalDeductionsDisplay">0 د.ج</div>
                </div>
                <div class="salary-summary-item">
                    <h4>إجمالي العلاوات</h4>
                    <div class="amount salary-bonuses" id="totalBonusesDisplay">0 د.ج</div>
                </div>
                <div class="salary-summary-item">
                    <h4>صافي الراتب</h4>
                    <div class="amount salary-net" id="netSalaryDisplay">0 د.ج</div>
                </div>
            </div>

            <div class="button-group">
                <button id="saveSalaryBtn" class="btn">
                    <i class="fas fa-save"></i> حفظ الراتب
                </button>
                <button id="payAllBtn" class="btn pay-all-btn">
                    <i class="fas fa-users"></i> دفع جميع الرواتب
                </button>
                <button id="printSalaryBtn" class="btn btn-accent">
                    <i class="fas fa-print"></i> طباعة الراتب
                </button>
                <button id="editSalaryBtn" class="btn btn-secondary" style="display: none;">
                    <i class="fas fa-edit"></i> تعديل الراتب
                </button>
                <button id="manageBudgetBtn" class="btn" style="background-color: #6a1b9a;">
                    <i class="fas fa-coins"></i> إدارة الميزانية
                </button>
            </div>
        </div>

        <div id="message" class="message"></div>

        <!-- قسم التقرير المالي -->
        <div class="financial-report" id="financialReport">
            <h2 class="card-title">التقرير المالي</h2>
            
            <div class="report-controls">
                <select id="reportMonthSelect" class="salary-input">
                    <option value="">كل الأشهر</option>
                    <option value="1">جانفي</option>
                    <option value="2">فيفري</option>
                    <option value="3">مارس</option>
                    <option value="4">أفريل</option>
                    <option value="5">ماي</option>
                    <option value="6">جوان</option>
                    <option value="7">جويلية</option>
                    <option value="8">أوت</option>
                    <option value="9">سبتمبر</option>
                    <option value="10">أكتوبر</option>
                    <option value="11">نوفمبر</option>
                    <option value="12">ديسمبر</option>
                </select>
                
                <select id="reportYearSelect" class="salary-input">
                    <option value="">كل السنوات</option>
                </select>
                
                <input type="text" id="teacherSearch" class="salary-input search-box" placeholder="بحث باسم المعلم...">
                
                <button id="refreshReportBtn" class="btn btn-secondary">
                    <i class="fas fa-sync-alt"></i> تحديث
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>اسم المعلم</th>
                            <th>الشهر</th>
                            <th>السنة</th>
                            <th>الراتب الأساسي</th>
                            <th>الخصومات</th>
                            <th>العلاوات</th>
                            <th>صافي الراتب</th>
                            <th>تاريخ الدفع</th>
                            <th>إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <!-- سيتم ملؤها ديناميكياً -->
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="3">الإجمالي</td>
                            <td id="totalBaseSalary">0 د.ج</td>
                            <td id="totalDeductions">0 د.ج</td>
                            <td id="totalBonuses">0 د.ج</td>
                            <td id="totalNetSalary">0 د.ج</td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>جميع الحقوق محفوظة &copy; <span id="currentYear"></span> - نظام إدارة الرواتب</p>
    </div>

    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDv0Qk5j4Q6Q9XQ9XQ9XQ9XQ9XQ9XQ9XQ",
            authDomain: "budget-fddd7.firebaseapp.com",
            databaseURL: "https://budget-fddd7-default-rtdb.firebaseio.com",
            projectId: "budget-fddd7",
            storageBucket: "budget-fddd7.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        document.addEventListener('DOMContentLoaded', function() {
            // تعيين السنة الحالية في التذييل
            const currentYear = new Date().getFullYear();
            document.getElementById('currentYear').textContent = currentYear;
            
            // تعيين الشهر والسنة الحاليين تلقائياً
            const currentMonth = new Date().getMonth() + 1;
            document.getElementById('monthSelect').value = currentMonth;
            document.getElementById('yearSelect').value = currentYear;
            
            // روابط البيانات
            const TEACHERS_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQqw5oqA3vMBBIDqLd7OvhcxaPU807iKdv3txmrEhl-9Ln6snO5g7JtgJDxZHcRPUdBF4sbwzbsDAUC/pub?output=csv';
            const BUDGET_FIREBASE_PATH = 'currentBalance';
            const SALARIES_FIREBASE_PATH = 'salaries';
            const BUDGET_HISTORY_PATH = 'budgetHistory';
            const LAST_YEAR_BUDGET_PATH = 'lastYearBudget';
            
            // العناصر الرئيسية
            const teacherSelect = document.getElementById('teacherSelect');
            const monthSelect = document.getElementById('monthSelect');
            const yearSelect = document.getElementById('yearSelect');
            const baseSalaryInput = document.getElementById('baseSalary');
            const deductionsContainer = document.getElementById('deductionsContainer');
            const bonusesContainer = document.getElementById('bonusesContainer');
            const addDeductionBtn = document.getElementById('addDeductionBtn');
            const addBonusBtn = document.getElementById('addBonusBtn');
            const saveSalaryBtn = document.getElementById('saveSalaryBtn');
            const payAllBtn = document.getElementById('payAllBtn');
            const printSalaryBtn = document.getElementById('printSalaryBtn');
            const editSalaryBtn = document.getElementById('editSalaryBtn');
            const manageBudgetBtn = document.getElementById('manageBudgetBtn');
            const messageDiv = document.getElementById('message');
            
            // عناصر الميزانية
            const currentMonthSalariesEl = document.getElementById('currentMonthSalaries');
            const seasonSalariesEl = document.getElementById('seasonSalaries');
            const remainingBudgetEl = document.getElementById('remainingBudget');
            const otherExpensesEl = document.getElementById('otherExpenses');
            
            // عناصر التقرير المالي
            const reportMonthSelect = document.getElementById('reportMonthSelect');
            const reportYearSelect = document.getElementById('reportYearSelect');
            const teacherSearch = document.getElementById('teacherSearch');
            const refreshReportBtn = document.getElementById('refreshReportBtn');
            const reportTableBody = document.getElementById('reportTableBody');
            
            // عناصر النوافذ المنبثقة
            const infoIcon = document.getElementById('infoIcon');
            const infoModal = document.getElementById('infoModal');
            const closeModal = document.getElementById('closeModal');
            const confirmPayAllModal = document.getElementById('confirmPayAllModal');
            const teachersPayList = document.getElementById('teachersPayList');
            const confirmPayAllBtn = document.getElementById('confirmPayAllBtn');
            const cancelPayAllBtn = document.getElementById('cancelPayAllBtn');
            const budgetManagementModal = document.getElementById('budgetManagementModal');
            const saveBudgetChangesBtn = document.getElementById('saveBudgetChangesBtn');
            const cancelBudgetChangesBtn = document.getElementById('cancelBudgetChangesBtn');
            const totalBudgetInput = document.getElementById('totalBudget');
            const transferFromLastYearInput = document.getElementById('transferFromLastYear');
            const donationsAmountInput = document.getElementById('donationsAmount');
            const donorNameInput = document.getElementById('donorName');
            const budgetHistoryBody = document.getElementById('budgetHistoryBody');
            const reportSideBtn = document.getElementById('reportSideBtn');
            const printReportModal = document.getElementById('printReportModal');
            const printMonthlyReport = document.getElementById('printMonthlyReport');
            const printYearlyReport = document.getElementById('printYearlyReport');
            const printCustomReport = document.getElementById('printCustomReport');
            const closePrintModalBtn = document.getElementById('closePrintModalBtn');
            const financialReport = document.getElementById('financialReport');
            
            // متغيرات التخزين
            let teachersData = [];
            let budgetData = {
                monthly: 0,
                paid: 0,
                expenses: 0,
                remaining: 0,
                currentMonthSalaries: 0,
                seasonSalaries: 0,
                lastYearRemaining: 0
            };
            let salaryRecords = [];
            let currentEditingSalaryId = null;
            let selectedTeachersToPay = [];
            
            // أحداث النموذج
            addDeductionBtn.addEventListener('click', addDeductionField);
            addBonusBtn.addEventListener('click', addBonusField);
            saveSalaryBtn.addEventListener('click', saveSalary);
            payAllBtn.addEventListener('click', showPayAllModal);
            confirmPayAllBtn.addEventListener('click', paySelectedSalaries);
            cancelPayAllBtn.addEventListener('click', () => confirmPayAllModal.style.display = 'none');
            printSalaryBtn.addEventListener('click', printCurrentSalary);
            editSalaryBtn.addEventListener('click', editSalary);
            manageBudgetBtn.addEventListener('click', showBudgetManagementModal);
            saveBudgetChangesBtn.addEventListener('click', saveBudgetChanges);
            cancelBudgetChangesBtn.addEventListener('click', () => budgetManagementModal.style.display = 'none');
            refreshReportBtn.addEventListener('click', loadSalaryData);
            baseSalaryInput.addEventListener('input', calculateNetSalary);
            teacherSearch.addEventListener('input', filterSalaryReport);
            reportMonthSelect.addEventListener('change', filterSalaryReport);
            reportYearSelect.addEventListener('change', filterSalaryReport);
            infoIcon.addEventListener('click', () => infoModal.style.display = 'flex');
            closeModal.addEventListener('click', () => infoModal.style.display = 'none');
            reportSideBtn.addEventListener('click', () => printReportModal.style.display = 'flex');
            printMonthlyReport.addEventListener('click', () => printReport('monthly'));
            printYearlyReport.addEventListener('click', () => printReport('yearly'));
            printCustomReport.addEventListener('click', () => printReport('custom'));
            closePrintModalBtn.addEventListener('click', () => printReportModal.style.display = 'none');
            transferFromLastYearInput.addEventListener('input', updateTotalBudget);
            donationsAmountInput.addEventListener('input', updateTotalBudget);
            
            // تحميل البيانات الأولية
            loadTeachersData();
            loadBudgetData();
            loadSalaryData();
            populateYearSelect();
            
            // تعبئة قائمة السنوات للتقرير
            function populateYearSelect() {
                reportYearSelect.innerHTML = '<option value="">كل السنوات</option>';
                const currentYear = new Date().getFullYear();
                for (let year = 2020; year <= currentYear; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    reportYearSelect.appendChild(option);
                }
            }
            
            // دالة جلب بيانات المعلمين من Google Sheets
            async function loadTeachersData() {
                try {
                    showMessage('جاري تحميل بيانات المعلمين...', 'warning');
                    
                    const response = await fetch(TEACHERS_SHEET_URL);
                    
                    if (!response.ok) throw new Error('فشل في جلب بيانات المعلمين');
                    
                    const csvData = await response.text();
                    teachersData = parseTeachersCSVData(csvData);
                    
                    populateTeacherSelect();
                    showMessage('تم تحميل بيانات المعلمين بنجاح', 'success');
                    
                } catch (error) {
                    console.error('Error loading teachers:', error);
                    showMessage(`حدث خطأ: ${error.message}`, 'error');
                }
            }
            
            // دالة تحليل بيانات المعلمين من CSV
            function parseTeachersCSVData(csv) {
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                // البحث عن أعمدة الاسم والراتب
                const nameIndex = headers.findIndex(h => h.includes('اسم') || h.includes('الاسم') || h.includes('Name'));
                const salaryIndex = headers.findIndex(h => h.includes('راتب') || h.includes('الراتب') || h.includes('Salary'));
                
                if (nameIndex === -1 || salaryIndex === -1) {
                    throw new Error('هيكل الجدول غير متطابق - تأكد من وجود أعمدة الاسم والراتب');
                }
                
                const teachers = [];
                for (let i = 1; i < lines.length; i++) {
                    const cells = lines[i].split(',');
                    if (cells.length > Math.max(nameIndex, salaryIndex)) {
                        const name = cells[nameIndex].trim();
                        const salary = parseFloat(cells[salaryIndex]) || 0;
                        
                        if (name) {
                            teachers.push({
                                id: i,
                                name: name,
                                baseSalary: salary
                            });
                        }
                    }
                }
                
                return teachers;
            }
            
            // دالة جلب بيانات الميزانية من Firebase
            async function loadBudgetData() {
                try {
                    showMessage('جاري تحميل بيانات الميزانية...', 'warning');
                    
                    const [currentSnapshot, lastYearSnapshot] = await Promise.all([
                        database.ref(BUDGET_FIREBASE_PATH).once('value'),
                        database.ref(LAST_YEAR_BUDGET_PATH).once('value')
                    ]);
                    
                    if (currentSnapshot.exists()) {
                        const currentMonth = new Date().getMonth() + 1;
                        const currentYear = new Date().getFullYear();
                        
                        // حساب الرواتب لهذا الشهر
                        const currentMonthSalaries = salaryRecords
                            .filter(s => s.month == currentMonth && s.year == currentYear)
                            .reduce((sum, s) => sum + s.netSalary, 0);
                        
                        // حساب الرواتب للموسم الحالي (السنة الحالية)
                        const seasonSalaries = salaryRecords
                            .filter(s => s.year == currentYear)
                            .reduce((sum, s) => sum + s.netSalary, 0);
                        
                        budgetData = {
                            monthly: currentSnapshot.val().monthly || 0,
                            paid: currentSnapshot.val().paid || 0,
                            expenses: currentSnapshot.val().expenses || 0,
                            remaining: currentSnapshot.val().remaining || 0,
                            currentMonthSalaries: currentMonthSalaries,
                            seasonSalaries: seasonSalaries,
                            lastYearRemaining: lastYearSnapshot.exists() ? lastYearSnapshot.val().remaining || 0 : 0
                        };
                    } else {
                        // قيم افتراضية إذا لم تكن البيانات موجودة
                        budgetData = {
                            monthly: 0,
                            paid: 0,
                            expenses: 0,
                            remaining: 0,
                            currentMonthSalaries: 0,
                            seasonSalaries: 0,
                            lastYearRemaining: 0
                        };
                    }
                    
                    // تحديث حقول إدارة الميزانية
                    totalBudgetInput.value = budgetData.monthly;
                    transferFromLastYearInput.value = '';
                    donationsAmountInput.value = '';
                    donorNameInput.value = '';
                    
                    updateBudgetDisplay();
                    showMessage('تم تحميل بيانات الميزانية بنجاح', 'success');
                    
                } catch (error) {
                    console.error('Error loading budget:', error);
                    showMessage(`حدث خطأ: ${error.message}`, 'error');
                }
            }
            
            // دالة تحديث الميزانية الإجمالية تلقائياً
            function updateTotalBudget() {
                const transferAmount = parseFloat(transferFromLastYearInput.value) || 0;
                const donationsAmount = parseFloat(donationsAmountInput.value) || 0;
                
                // حساب الميزانية الجديدة بناء على المتبقي من السنة السابقة والتبرعات
                const newTotalBudget = budgetData.lastYearRemaining + transferAmount + donationsAmount;
                totalBudgetInput.value = newTotalBudget.toFixed(2);
            }
            
            // دالة جلب سجل تعديلات الميزانية
            async function loadBudgetHistory() {
                try {
                    const snapshot = await database.ref(BUDGET_HISTORY_PATH).once('value');
                    budgetHistoryBody.innerHTML = '';
                    
                    if (snapshot.exists()) {
                        const historyData = [];
                        snapshot.forEach(childSnapshot => {
                            historyData.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                        
                        // ترتيب السجل من الأحدث إلى الأقدم
                        historyData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        
                        // عرض السجل
                        historyData.forEach(record => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${formatDate(record.timestamp)}</td>
                                <td>${record.type}</td>
                                <td>${record.amount.toFixed(2)} د.ج</td>
                                <td>${record.notes || ''}</td>
                            `;
                            budgetHistoryBody.appendChild(row);
                        });
                    }
                } catch (error) {
                    console.error('Error loading budget history:', error);
                    showMessage(`حدث خطأ أثناء تحميل سجل الميزانية: ${error.message}`, 'error');
                }
            }
            
            // دالة تنسيق التاريخ بالأرقام الأجنبية
            function formatDate(dateString) {
                const date = new Date(dateString);
                const options = {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                return date.toLocaleDateString('ar-EG', options).replace(/[٠-٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d));
            }
            
            // دالة تعبئة قائمة المعلمين
            function populateTeacherSelect() {
                teacherSelect.innerHTML = '<option value="">-- اختر المعلم --</option><option value="all">جميع المعلمين</option>';
                teachersData.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = `${teacher.name} (${teacher.baseSalary.toFixed(2)} د.ج)`;
                    option.dataset.salary = teacher.baseSalary;
                    teacherSelect.appendChild(option);
                });
                
                // إضافة حدث لتحديث الراتب عند اختيار المعلم
                teacherSelect.addEventListener('change', function() {
                    if (this.value === "all") {
                        baseSalaryInput.value = "";
                        baseSalaryInput.placeholder = "سيتم استخدام رواتب المعلمين";
                        return;
                    }
                    
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption.dataset.salary) {
                        baseSalaryInput.value = selectedOption.dataset.salary;
                        calculateNetSalary();
                    }
                });
            }
            
            // دالة تحديث عرض الميزانية
            function updateBudgetDisplay() {
                currentMonthSalariesEl.textContent = `${(budgetData.currentMonthSalaries || 0).toFixed(2)} د.ج`;
                seasonSalariesEl.textContent = `${(budgetData.seasonSalaries || 0).toFixed(2)} د.ج`;
                remainingBudgetEl.textContent = `${(budgetData.remaining || 0).toFixed(2)} د.ج`;
                otherExpensesEl.textContent = `${(budgetData.expenses || 0).toFixed(2)} د.ج`;
            }
            
            // دالة إضافة حقل خصم جديد
            function addDeductionField() {
                const deductionId = Date.now();
                const deductionField = document.createElement('div');
                deductionField.className = 'deduction-item';
                deductionField.innerHTML = `
                    <div style="display: flex; gap: 10px; width: 100%;">
                        <input type="text" class="salary-input" placeholder="وصف الخصم" id="deductionDesc_${deductionId}" style="flex: 2;">
                        <input type="number" class="salary-input" placeholder="المبلغ" id="deductionAmount_${deductionId}" style="flex: 1;">
                    </div>
                    <button type="button" class="remove-item-btn" data-id="${deductionId}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                deductionsContainer.appendChild(deductionField);
                
                // إضافة حدث لحذف الخصم
                deductionField.querySelector('.remove-item-btn').addEventListener('click', function() {
                    deductionsContainer.removeChild(deductionField);
                    calculateNetSalary();
                });
                
                // إضافة حدث لحساب الراتب عند تغيير المبلغ
                deductionField.querySelector(`#deductionAmount_${deductionId}`).addEventListener('input', calculateNetSalary);
            }
            
            // دالة إضافة حقل علاوة جديدة
            function addBonusField() {
                const bonusId = Date.now();
                const bonusField = document.createElement('div');
                bonusField.className = 'bonus-item';
                bonusField.innerHTML = `
                    <div style="display: flex; gap: 10px; width: 100%;">
                        <input type="text" class="salary-input" placeholder="وصف العلاوة" id="bonusDesc_${bonusId}" style="flex: 2;">
                        <input type="number" class="salary-input" placeholder="المبلغ" id="bonusAmount_${bonusId}" style="flex: 1;">
                    </div>
                    <button type="button" class="remove-item-btn" data-id="${bonusId}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                bonusesContainer.appendChild(bonusField);
                
                // إضافة حدث لحذف العلاوة
                bonusField.querySelector('.remove-item-btn').addEventListener('click', function() {
                    bonusesContainer.removeChild(bonusField);
                    calculateNetSalary();
                });
                
                // إضافة حدث لحساب الراتب عند تغيير المبلغ
                bonusField.querySelector(`#bonusAmount_${bonusId}`).addEventListener('input', calculateNetSalary);
            }
            
            // دالة حساب صافي الراتب
            function calculateNetSalary() {
                const baseSalary = parseFloat(baseSalaryInput.value) || 0;
                
                // حساب إجمالي الخصومات
                let totalDeductions = 0;
                const deductionAmounts = deductionsContainer.querySelectorAll('input[type="number"]');
                deductionAmounts.forEach(input => {
                    totalDeductions += parseFloat(input.value) || 0;
                });
                
                // حساب إجمالي العلاوات
                let totalBonuses = 0;
                const bonusAmounts = bonusesContainer.querySelectorAll('input[type="number"]');
                bonusAmounts.forEach(input => {
                    totalBonuses += parseFloat(input.value) || 0;
                });
                
                // حساب صافي الراتب
                const netSalary = baseSalary - totalDeductions + totalBonuses;
                
                // تحديث العرض
                document.getElementById('baseSalaryDisplay').textContent = baseSalary.toFixed(2) + ' د.ج';
                document.getElementById('totalDeductionsDisplay').textContent = totalDeductions.toFixed(2) + ' د.ج';
                document.getElementById('totalBonusesDisplay').textContent = totalBonuses.toFixed(2) + ' د.ج';
                document.getElementById('netSalaryDisplay').textContent = netSalary.toFixed(2) + ' د.ج';
                
                // التحقق من الميزانية
                checkBudget(netSalary);
            }
            
            // دالة التحقق من الميزانية
            function checkBudget(netSalary) {
                const remainingBudget = budgetData.remaining || 0;
                
                if (netSalary > remainingBudget) {
                    showMessage('تحذير: صافي الراتب يتجاوز الميزانية المتبقية', 'warning');
                    document.getElementById('netSalaryDisplay').style.color = 'var(--deduction-color)';
                } else {
                    document.getElementById('netSalaryDisplay').style.color = 'var(--primary-color)';
                }
            }
            
            // دالة حفظ الراتب في Firebase
            async function saveSalary() {
                const teacherId = teacherSelect.value;
                const month = monthSelect.value;
                const year = yearSelect.value;
                
                if (teacherId === "all") {
                    showMessage('الرجاء اختيار معلم واحد لحفظ راتبه', 'error');
                    return;
                }
                
                if (!teacherId || !month || !year) {
                    showMessage('الرجاء إدخال جميع البيانات المطلوبة بشكل صحيح', 'error');
                    return;
                }
                
                const teacherName = teacherSelect.options[teacherSelect.selectedIndex].text.split(' (')[0];
                const monthName = monthSelect.options[monthSelect.selectedIndex].text;
                const baseSalary = parseFloat(baseSalaryInput.value) || 0;
                
                // جمع بيانات الخصومات
                const deductionsData = [];
                const deductionItems = deductionsContainer.querySelectorAll('.deduction-item');
                deductionItems.forEach(item => {
                    const desc = item.querySelector('input[type="text"]').value;
                    const amount = parseFloat(item.querySelector('input[type="number"]').value) || 0;
                    if (desc && amount > 0) {
                        deductionsData.push({ desc, amount });
                    }
                });
                
                // جمع بيانات العلاوات
                const bonusesData = [];
                const bonusItems = bonusesContainer.querySelectorAll('.bonus-item');
                bonusItems.forEach(item => {
                    const desc = item.querySelector('input[type="text"]').value;
                    const amount = parseFloat(item.querySelector('input[type="number"]').value) || 0;
                    if (desc && amount > 0) {
                        bonusesData.push({ desc, amount });
                    }
                });
                
                // حساب الإجماليات
                const totalDeductions = deductionsData.reduce((sum, item) => sum + item.amount, 0);
                const totalBonuses = bonusesData.reduce((sum, item) => sum + item.amount, 0);
                const netSalary = baseSalary - totalDeductions + totalBonuses;
                
                // إنشاء كائن الراتب
                const salaryRecord = {
                    teacherId,
                    teacherName,
                    month,
                    monthName,
                    year,
                    baseSalary,
                    deductions: deductionsData,
                    totalDeductions,
                    bonuses: bonusesData,
                    totalBonuses,
                    netSalary,
                    createdAt: new Date().toISOString()
                };
                
                try {
                    showMessage('جاري حفظ بيانات الراتب...', 'warning');
                    
                    // حفظ الراتب في Firebase
                    let salaryRef;
                    if (currentEditingSalaryId) {
                        // حالة التعديل على راتب موجود
                        salaryRef = database.ref(`${SALARIES_FIREBASE_PATH}/${currentEditingSalaryId}`);
                        await salaryRef.update(salaryRecord);
                    } else {
                        // حالة إضافة راتب جديد
                        salaryRef = database.ref(SALARIES_FIREBASE_PATH).push();
                        await salaryRef.set(salaryRecord);
                    }
                    
                    // تحديث الميزانية في Firebase
                    const newPaidSalaries = (budgetData.paid || 0) + netSalary;
                    const newRemainingBudget = (budgetData.monthly || 0) - newPaidSalaries - (budgetData.expenses || 0);
                    
                    // حساب الرواتب لهذا الشهر وللموسم
                    const currentMonth = new Date().getMonth() + 1;
                    const currentYear = new Date().getFullYear();
                    const isCurrentMonth = month == currentMonth && year == currentYear;
                    const isCurrentSeason = year == currentYear;
                    
                    await database.ref(BUDGET_FIREBASE_PATH).update({
                        paid: newPaidSalaries,
                        remaining: newRemainingBudget,
                        currentMonthSalaries: isCurrentMonth ? 
                            (budgetData.currentMonthSalaries || 0) + netSalary : 
                            budgetData.currentMonthSalaries,
                        seasonSalaries: isCurrentSeason ? 
                            (budgetData.seasonSalaries || 0) + netSalary : 
                            budgetData.seasonSalaries
                    });
                    
                    // تحديث البيانات المحلية
                    budgetData.paid = newPaidSalaries;
                    budgetData.remaining = newRemainingBudget;
                    
                    if (isCurrentMonth) {
                        budgetData.currentMonthSalaries = (budgetData.currentMonthSalaries || 0) + netSalary;
                    }
                    
                    if (isCurrentSeason) {
                        budgetData.seasonSalaries = (budgetData.seasonSalaries || 0) + netSalary;
                    }
                    
                    updateBudgetDisplay();
                    
                    // إعادة تحميل سجلات الرواتب
                    await loadSalaryData();
                    
                    showMessage(currentEditingSalaryId ? 'تم تحديث بيانات الراتب بنجاح' : 'تم حفظ بيانات الراتب بنجاح', 'success');
                    resetSalaryForm();
                    
                    // إخفاء زر التعديل وإظهار زر الحفظ
                    editSalaryBtn.style.display = 'none';
                    saveSalaryBtn.style.display = 'inline-flex';
                    
                } catch (error) {
                    console.error('Error saving salary:', error);
                    showMessage(`حدث خطأ أثناء حفظ الراتب: ${error.message}`, 'error');
                }
            }
            
            // دالة عرض نافذة دفع جميع الرواتب
            function showPayAllModal() {
                const month = monthSelect.value;
                const year = yearSelect.value;
                
                if (!month || !year) {
                    showMessage('الرجاء تحديد الشهر والسنة', 'error');
                    return;
                }
                
                if (teachersData.length === 0) {
                    showMessage('لا يوجد معلمين لدفع رواتبهم', 'error');
                    return;
                }
                
                // تعبئة قائمة المعلمين للدفع
                teachersPayList.innerHTML = '';
                selectedTeachersToPay = [];
                
                // جمع بيانات الخصومات والعلاوات العامة
                const generalDeductions = [];
                const deductionItems = deductionsContainer.querySelectorAll('.deduction-item');
                deductionItems.forEach(item => {
                    const desc = item.querySelector('input[type="text"]').value;
                    const amount = parseFloat(item.querySelector('input[type="number"]').value) || 0;
                    if (desc && amount > 0) {
                        generalDeductions.push({ desc, amount });
                    }
                });
                
                const generalBonuses = [];
                const bonusItems = bonusesContainer.querySelectorAll('.bonus-item');
                bonusItems.forEach(item => {
                    const desc = item.querySelector('input[type="text"]').value;
                    const amount = parseFloat(item.querySelector('input[type="number"]').value) || 0;
                    if (desc && amount > 0) {
                        generalBonuses.push({ desc, amount });
                    }
                });
                
                // حساب إجمالي الخصومات والعلاوات العامة
                const totalGeneralDeductions = generalDeductions.reduce((sum, item) => sum + item.amount, 0);
                const totalGeneralBonuses = generalBonuses.reduce((sum, item) => sum + item.amount, 0);
                
                teachersData.forEach(teacher => {
                    const teacherItem = document.createElement('div');
                    teacherItem.className = 'teacher-pay-item';
                    
                    const netSalary = teacher.baseSalary - totalGeneralDeductions + totalGeneralBonuses;
                    
                    teacherItem.innerHTML = `
                        <input type="checkbox" id="teacher_${teacher.id}" value="${teacher.id}" checked>
                        <div class="teacher-pay-details">
                            <div>${teacher.name}</div>
                            <div class="teacher-pay-salary">${netSalary.toFixed(2)} د.ج</div>
                        </div>
                    `;
                    
                    teachersPayList.appendChild(teacherItem);
                    
                    // إضافة المعلم إلى القائمة المحددة
                    selectedTeachersToPay.push({
                        id: teacher.id,
                        name: teacher.name,
                        baseSalary: teacher.baseSalary,
                        netSalary: netSalary
                    });
                    
                    // إضافة حدث لتحديث القائمة المحددة
                    teacherItem.querySelector('input[type="checkbox"]').addEventListener('change', function() {
                        const teacherId = this.value;
                        if (this.checked) {
                            // إضافة المعلم إذا لم يكن موجوداً
                            if (!selectedTeachersToPay.some(t => t.id == teacherId)) {
                                selectedTeachersToPay.push({
                                    id: teacher.id,
                                    name: teacher.name,
                                    baseSalary: teacher.baseSalary,
                                    netSalary: netSalary
                                });
                            }
                        } else {
                            // إزالة المعلم إذا كان موجوداً
                            selectedTeachersToPay = selectedTeachersToPay.filter(t => t.id != teacherId);
                        }
                    });
                });
                
                confirmPayAllModal.style.display = 'flex';
            }
            
            // دالة دفع رواتب المعلمين المحددين
            async function paySelectedSalaries() {
                const month = monthSelect.value;
                const year = yearSelect.value;
                
                if (selectedTeachersToPay.length === 0) {
                    showMessage('الرجاء تحديد معلم واحد على الأقل لدفع راتبه', 'error');
                    return;
                }
                
                try {
                    showMessage('جاري دفع الرواتب المحددة...', 'warning');
                    
                    let totalNetSalaries = 0;
                    const monthName = monthSelect.options[monthSelect.selectedIndex].text;
                    
                    // جمع بيانات الخصومات والعلاوات العامة
                    const generalDeductions = [];
                    const deductionItems = deductionsContainer.querySelectorAll('.deduction-item');
                    deductionItems.forEach(item => {
                        const desc = item.querySelector('input[type="text"]').value;
                        const amount = parseFloat(item.querySelector('input[type="number"]').value) || 0;
                        if (desc && amount > 0) {
                            generalDeductions.push({ desc, amount });
                        }
                    });
                    
                    const generalBonuses = [];
                    const bonusItems = bonusesContainer.querySelectorAll('.bonus-item');
                    bonusItems.forEach(item => {
                        const desc = item.querySelector('input[type="text"]').value;
                        const amount = parseFloat(item.querySelector('input[type="number"]').value) || 0;
                        if (desc && amount > 0) {
                            generalBonuses.push({ desc, amount });
                        }
                    });
                    
                    // حساب إجمالي الخصومات والعلاوات العامة
                    const totalGeneralDeductions = generalDeductions.reduce((sum, item) => sum + item.amount, 0);
                    const totalGeneralBonuses = generalBonuses.reduce((sum, item) => sum + item.amount, 0);
                    
                    // دفع رواتب المعلمين المحددين
                    for (const teacher of selectedTeachersToPay) {
                        // إنشاء كائن الراتب
                        const salaryRecord = {
                            teacherId: teacher.id,
                            teacherName: teacher.name,
                            month,
                            monthName,
                            year,
                            baseSalary: teacher.baseSalary,
                            deductions: generalDeductions,
                            totalDeductions: totalGeneralDeductions,
                            bonuses: generalBonuses,
                            totalBonuses: totalGeneralBonuses,
                            netSalary: teacher.netSalary,
                            createdAt: new Date().toISOString()
                        };
                        
                        // حفظ الراتب في Firebase
                        const newSalaryRef = database.ref(SALARIES_FIREBASE_PATH).push();
                        await newSalaryRef.set(salaryRecord);
                        
                        totalNetSalaries += teacher.netSalary;
                    }
                    
                    // تحديث الميزانية في Firebase
                    const newPaidSalaries = (budgetData.paid || 0) + totalNetSalaries;
                    const newRemainingBudget = (budgetData.monthly || 0) - newPaidSalaries - (budgetData.expenses || 0);
                    
                    // حساب الرواتب لهذا الشهر وللموسم
                    const currentMonth = new Date().getMonth() + 1;
                    const currentYear = new Date().getFullYear();
                    const isCurrentMonth = month == currentMonth && year == currentYear;
                    const isCurrentSeason = year == currentYear;
                    
                    await database.ref(BUDGET_FIREBASE_PATH).update({
                        paid: newPaidSalaries,
                        remaining: newRemainingBudget,
                        currentMonthSalaries: isCurrentMonth ? 
                            (budgetData.currentMonthSalaries || 0) + totalNetSalaries : 
                            budgetData.currentMonthSalaries,
                        seasonSalaries: isCurrentSeason ? 
                            (budgetData.seasonSalaries || 0) + totalNetSalaries : 
                            budgetData.seasonSalaries
                    });
                    
                    // تحديث البيانات المحلية
                    budgetData.paid = newPaidSalaries;
                    budgetData.remaining = newRemainingBudget;
                    
                    if (isCurrentMonth) {
                        budgetData.currentMonthSalaries = (budgetData.currentMonthSalaries || 0) + totalNetSalaries;
                    }
                    
                    if (isCurrentSeason) {
                        budgetData.seasonSalaries = (budgetData.seasonSalaries || 0) + totalNetSalaries;
                    }
                    
                    updateBudgetDisplay();
                    
                    // إعادة تحميل سجلات الرواتب
                    await loadSalaryData();
                    
                    showMessage(`تم دفع رواتب ${selectedTeachersToPay.length} معلم بنجاح`, 'success');
                    resetSalaryForm();
                    confirmPayAllModal.style.display = 'none';
                    
                } catch (error) {
                    console.error('Error paying salaries:', error);
                    showMessage(`حدث خطأ أثناء دفع الرواتب: ${error.message}`, 'error');
                }
            }
            
            // دالة تحميل بيانات الرواتب من Firebase
            async function loadSalaryData() {
                try {
                    showMessage('جاري تحميل سجلات الرواتب...', 'warning');
                    
                    const snapshot = await database.ref(SALARIES_FIREBASE_PATH).once('value');
                    salaryRecords = [];
                    
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            salaryRecords.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                    }
                    
                    // تحديث بيانات الميزانية بعد تحميل الرواتب
                    const currentMonth = new Date().getMonth() + 1;
                    const currentYear = new Date().getFullYear();
                    
                    budgetData.currentMonthSalaries = salaryRecords
                        .filter(s => s.month == currentMonth && s.year == currentYear)
                        .reduce((sum, s) => sum + s.netSalary, 0);
                    
                    budgetData.seasonSalaries = salaryRecords
                        .filter(s => s.year == currentYear)
                        .reduce((sum, s) => sum + s.netSalary, 0);
                    
                    updateBudgetDisplay();
                    updateSalaryReport();
                    showMessage('تم تحميل سجلات الرواتب بنجاح', 'success');
                    
                } catch (error) {
                    console.error('Error loading salaries:', error);
                    showMessage(`حدث خطأ أثناء تحميل سجلات الرواتب: ${error.message}`, 'error');
                }
            }
            
            // دالة تحديث التقرير المالي
            function updateSalaryReport() {
                reportTableBody.innerHTML = '';
                
                let totalBase = 0;
                let totalDeductions = 0;
                let totalBonuses = 0;
                let totalNet = 0;
                
                salaryRecords.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.teacherName}</td>
                        <td>${record.monthName}</td>
                        <td>${record.year}</td>
                        <td>${record.baseSalary.toFixed(2)} د.ج</td>
                        <td>${record.totalDeductions.toFixed(2)} د.ج</td>
                        <td>${record.totalBonuses.toFixed(2)} د.ج</td>
                        <td>${record.netSalary.toFixed(2)} د.ج</td>
                        <td>${formatDate(record.createdAt)}</td>
                        <td>
                            <button class="edit-salary-btn" data-id="${record.id}" style="background-color: var(--accent-color); padding: 5px 10px; border-radius: 4px; color: white; border: none; cursor: pointer;">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    `;
                    reportTableBody.appendChild(row);
                    
                    totalBase += record.baseSalary;
                    totalDeductions += record.totalDeductions;
                    totalBonuses += record.totalBonuses;
                    totalNet += record.netSalary;
                    
                    // إضافة حدث لتعديل الراتب
                    row.querySelector('.edit-salary-btn').addEventListener('click', function() {
                        const salaryId = this.getAttribute('data-id');
                        const salaryRecord = salaryRecords.find(r => r.id === salaryId);
                        if (salaryRecord) {
                            editSalaryForm(salaryRecord);
                        }
                    });
                });
                
                // تحديث الإجماليات
                document.getElementById('totalBaseSalary').textContent = totalBase.toFixed(2) + ' د.ج';
                document.getElementById('totalDeductions').textContent = totalDeductions.toFixed(2) + ' د.ج';
                document.getElementById('totalBonuses').textContent = totalBonuses.toFixed(2) + ' د.ج';
                document.getElementById('totalNetSalary').textContent = totalNet.toFixed(2) + ' د.ج';
            }
            
            // دالة تعبئة النموذج لتعديل الراتب
            function editSalaryForm(salaryRecord) {
                // تعبئة البيانات الأساسية
                teacherSelect.value = salaryRecord.teacherId;
                monthSelect.value = salaryRecord.month;
                yearSelect.value = salaryRecord.year;
                baseSalaryInput.value = salaryRecord.baseSalary;
                
                // تعبئة الخصومات
                deductionsContainer.innerHTML = '';
                salaryRecord.deductions.forEach(deduction => {
                    addDeductionField();
                    const lastDeduction = deductionsContainer.lastChild;
                    lastDeduction.querySelector('input[type="text"]').value = deduction.desc;
                    lastDeduction.querySelector('input[type="number"]').value = deduction.amount;
                });
                
                // تعبئة العلاوات
                bonusesContainer.innerHTML = '';
                salaryRecord.bonuses.forEach(bonus => {
                    addBonusField();
                    const lastBonus = bonusesContainer.lastChild;
                    lastBonus.querySelector('input[type="text"]').value = bonus.desc;
                    lastBonus.querySelector('input[type="number"]').value = bonus.amount;
                });
                
                // حساب صافي الراتب
                calculateNetSalary();
                
                // تعيين معرف الراتب الحالي للتعديل
                currentEditingSalaryId = salaryRecord.id;
                
                // إظهار زر التعديل وإخفاء زر الحفظ
                editSalaryBtn.style.display = 'inline-flex';
                saveSalaryBtn.style.display = 'none';
                
                // التمرير إلى أعلى النموذج
                document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
            }
            
            // دالة تعديل الراتب
            function editSalary() {
                if (currentEditingSalaryId) {
                    saveSalary();
                }
            }
            
            // دالة تصفية التقرير المالي
            function filterSalaryReport() {
                const monthFilter = reportMonthSelect.value;
                const yearFilter = reportYearSelect.value;
                const searchTerm = teacherSearch.value.toLowerCase();
                
                const rows = reportTableBody.querySelectorAll('tr');
                let totalBase = 0;
                let totalDeductions = 0;
                let totalBonuses = 0;
                let totalNet = 0;
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const teacherName = cells[0].textContent.toLowerCase();
                    const month = cells[1].textContent;
                    const year = cells[2].textContent;
                    
                    const monthMatch = !monthFilter || month === reportMonthSelect.options[reportMonthSelect.selectedIndex].text;
                    const yearMatch = !yearFilter || year === yearFilter;
                    const searchMatch = !searchTerm || teacherName.includes(searchTerm);
                    
                    if (monthMatch && yearMatch && searchMatch) {
                        row.style.display = '';
                        
                        // تحديث الإجماليات للصفوف المرئية فقط
                        totalBase += parseFloat(cells[3].textContent);
                        totalDeductions += parseFloat(cells[4].textContent);
                        totalBonuses += parseFloat(cells[5].textContent);
                        totalNet += parseFloat(cells[6].textContent);
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                // تحديث الإجماليات
                document.getElementById('totalBaseSalary').textContent = totalBase.toFixed(2) + ' د.ج';
                document.getElementById('totalDeductions').textContent = totalDeductions.toFixed(2) + ' د.ج';
                document.getElementById('totalBonuses').textContent = totalBonuses.toFixed(2) + ' د.ج';
                document.getElementById('totalNetSalary').textContent = totalNet.toFixed(2) + ' د.ج';
            }
            
            // دالة طباعة الراتب الحالي
            function printCurrentSalary() {
                const teacherId = teacherSelect.value;
                const month = monthSelect.value;
                const year = yearSelect.value;
                
                if (!teacherId || !month || !year) {
                    showMessage('الرجاء إدخال جميع البيانات المطلوبة بشكل صحيح', 'error');
                    return;
                }
                
                // إنشاء نافذة طباعة
                const printWindow = window.open('', '_blank');
                
                // محتوى الطباعة
                const teacherName = teacherSelect.options[teacherSelect.selectedIndex].text.split(' (')[0];
                const monthName = monthSelect.options[monthSelect.selectedIndex].text;
                const baseSalary = parseFloat(baseSalaryInput.value) || 0;
                
                // جمع بيانات الخصومات
                const deductionsData = [];
                const deductionItems = deductionsContainer.querySelectorAll('.deduction-item');
                deductionItems.forEach(item => {
                    const desc = item.querySelector('input[type="text"]').value;
                    const amount = parseFloat(item.querySelector('input[type="number"]').value) || 0;
                    if (desc && amount > 0) {
                        deductionsData.push({ desc, amount });
                    }
                });
                
                // جمع بيانات العلاوات
                const bonusesData = [];
                const bonusItems = bonusesContainer.querySelectorAll('.bonus-item');
                bonusItems.forEach(item => {
                    const desc = item.querySelector('input[type="text"]').value;
                    const amount = parseFloat(item.querySelector('input[type="number"]').value) || 0;
                    if (desc && amount > 0) {
                        bonusesData.push({ desc, amount });
                    }
                });
                
                // حساب الإجماليات
                const totalDeductions = deductionsData.reduce((sum, item) => sum + item.amount, 0);
                const totalBonuses = bonusesData.reduce((sum, item) => sum + item.amount, 0);
                const netSalary = baseSalary - totalDeductions + totalBonuses;
                
                // HTML للطباعة
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="ar" dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>كشف راتب المعلم</title>
                        <style>
                            body {
                                font-family: 'Cairo', sans-serif;
                                padding: 20px;
                                color: #333;
                            }
                            .print-header {
                                text-align: center;
                                margin-bottom: 30px;
                            }
                            .print-header h2 {
                                color: #1a4d2e;
                                margin-bottom: 5px;
                            }
                            .print-header p {
                                color: #666;
                            }
                            .print-details {
                                margin-bottom: 30px;
                            }
                            .print-table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-bottom: 30px;
                            }
                            .print-table th, .print-table td {
                                padding: 10px;
                                border: 1px solid #ddd;
                                text-align: right;
                            }
                            .print-table th {
                                background-color: #f5f5f5;
                            }
                            .print-totals {
                                display: grid;
                                grid-template-columns: repeat(2, 1fr);
                                gap: 20px;
                                margin-bottom: 30px;
                            }
                            .print-total {
                                padding: 15px;
                                border: 1px solid #ddd;
                                border-radius: 5px;
                                text-align: center;
                            }
                            .print-total h4 {
                                margin-top: 0;
                                color: #1a4d2e;
                            }
                            .print-total .amount {
                                font-size: 1.5rem;
                                font-weight: bold;
                            }
                            .print-signatures {
                                display: grid;
                                grid-template-columns: repeat(2, 1fr);
                                gap: 20px;
                                margin-top: 50px;
                            }
                            .print-signature {
                                text-align: center;
                                padding-top: 50px;
                                border-top: 1px solid #333;
                            }
                            @media print {
                                body {
                                    padding: 0;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="print-header">
                            <h2>كشف راتب المعلم</h2>
                            <p>نظام إدارة رواتب المعلمين - ${formatDate(new Date().toISOString())}</p>
                        </div>
                        
                        <div class="print-details">
                            <table class="print-table">
                                <tr>
                                    <th>اسم المعلم</th>
                                    <td>${teacherName}</td>
                                    <th>الشهر</th>
                                    <td>${monthName}</td>
                                </tr>
                                <tr>
                                    <th>السنة</th>
                                    <td>${year}</td>
                                    <th>تاريخ الطباعة</th>
                                    <td>${formatDate(new Date().toISOString())}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="print-details">
                            <h3>تفاصيل الراتب</h3>
                            <table class="print-table">
                                <tr>
                                    <th>الراتب الأساسي</th>
                                    <td>${baseSalary.toFixed(2)} د.ج</td>
                                </tr>
                                ${deductionsData.map(d => `
                                    <tr>
                                        <th>خصم: ${d.desc}</th>
                                        <td>${d.amount.toFixed(2)} د.ج</td>
                                    </tr>
                                `).join('')}
                                ${bonusesData.map(b => `
                                    <tr>
                                        <th>علاوة: ${b.desc}</th>
                                        <td>${b.amount.toFixed(2)} د.ج</td>
                                    </tr>
                                `).join('')}
                            </table>
                        </div>
                        
                        <div class="print-totals">
                            <div class="print-total">
                                <h4>إجمالي الخصومات</h4>
                                <div class="amount">${totalDeductions.toFixed(2)} د.ج</div>
                            </div>
                            <div class="print-total">
                                <h4>إجمالي العلاوات</h4>
                                <div class="amount">${totalBonuses.toFixed(2)} د.ج</div>
                            </div>
                        </div>
                        
                        <div class="print-total" style="grid-column: span 2;">
                            <h4>صافي الراتب المستحق</h4>
                            <div class="amount" style="color: #1a4d2e; font-size: 2rem;">${netSalary.toFixed(2)} د.ج</div>
                        </div>
                        
                        <div class="print-signatures">
                            <div class="print-signature">
                                <p>توقيع المحاسب</p>
                            </div>
                            <div class="print-signature">
                                <p>توقيع المستلم</p>
                            </div>
                        </div>
                        
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            };
                        <\/script>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
            }
            
            // دالة طباعة التقارير
            function printReport(type) {
                const printWindow = window.open('', '_blank');
                let title = '';
                let filteredRecords = [];
                
                // تحديد السجلات حسب نوع التقرير
                switch(type) {
                    case 'monthly':
                        const monthFilter = reportMonthSelect.value;
                        const yearFilter = reportYearSelect.value || new Date().getFullYear();
                        
                        if (!monthFilter) {
                            showMessage('الرجاء تحديد شهر لطباعة التقرير الشهري', 'error');
                            return;
                        }
                        
                        title = `تقرير رواتب شهر ${reportMonthSelect.options[monthFilter].text} ${yearFilter}`;
                        filteredRecords = salaryRecords.filter(r => 
                            r.month == monthFilter && r.year == yearFilter
                        );
                        break;
                        
                    case 'yearly':
                        const year = reportYearSelect.value || new Date().getFullYear();
                        
                        title = `تقرير رواتب سنة ${year}`;
                        filteredRecords = salaryRecords.filter(r => r.year == year);
                        break;
                        
                    case 'custom':
                        const currentMonthFilter = reportMonthSelect.value;
                        const currentYearFilter = reportYearSelect.value;
                        const searchTerm = teacherSearch.value.toLowerCase();
                        
                        title = 'تقرير رواتب مخصص';
                        filteredRecords = salaryRecords.filter(r => {
                            const monthMatch = !currentMonthFilter || r.month == currentMonthFilter;
                            const yearMatch = !currentYearFilter || r.year == currentYearFilter;
                            const searchMatch = !searchTerm || r.teacherName.toLowerCase().includes(searchTerm);
                            return monthMatch && yearMatch && searchMatch;
                        });
                        break;
                }
                
                // حساب الإجماليات
                const totalBase = filteredRecords.reduce((sum, r) => sum + r.baseSalary, 0);
                const totalDeductions = filteredRecords.reduce((sum, r) => sum + r.totalDeductions, 0);
                const totalBonuses = filteredRecords.reduce((sum, r) => sum + r.totalBonuses, 0);
                const totalNet = filteredRecords.reduce((sum, r) => sum + r.netSalary, 0);
                
                // HTML للطباعة
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="ar" dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>${title}</title>
                        <style>
                            body {
                                font-family: 'Cairo', sans-serif;
                                padding: 20px;
                                color: #333;
                            }
                            .print-header {
                                text-align: center;
                                margin-bottom: 30px;
                            }
                            .print-header h2 {
                                color: #1a4d2e;
                                margin-bottom: 5px;
                            }
                            .print-header p {
                                color: #666;
                            }
                            .print-table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-bottom: 30px;
                            }
                            .print-table th, .print-table td {
                                padding: 10px;
                                border: 1px solid #ddd;
                                text-align: right;
                            }
                            .print-table th {
                                background-color: #f5f5f5;
                            }
                            .print-totals {
                                display: grid;
                                grid-template-columns: repeat(4, 1fr);
                                gap: 15px;
                                margin-bottom: 30px;
                            }
                            .print-total {
                                padding: 15px;
                                border: 1px solid #ddd;
                                border-radius: 5px;
                                text-align: center;
                            }
                            .print-total h4 {
                                margin-top: 0;
                                color: #1a4d2e;
                            }
                            .print-total .amount {
                                font-size: 1.2rem;
                                font-weight: bold;
                            }
                            .print-signature {
                                text-align: center;
                                padding-top: 50px;
                                border-top: 1px solid #333;
                                margin-top: 50px;
                            }
                            @media print {
                                body {
                                    padding: 0;
                                }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="print-header">
                            <h2>${title}</h2>
                            <p>نظام إدارة رواتب المعلمين - ${formatDate(new Date().toISOString())}</p>
                        </div>
                        
                        <div class="print-details">
                            <table class="print-table">
                                <thead>
                                    <tr>
                                        <th>اسم المعلم</th>
                                        <th>الشهر</th>
                                        <th>السنة</th>
                                        <th>الراتب الأساسي</th>
                                        <th>الخصومات</th>
                                        <th>العلاوات</th>
                                        <th>صافي الراتب</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredRecords.map(r => `
                                        <tr>
                                            <td>${r.teacherName}</td>
                                            <td>${r.monthName}</td>
                                            <td>${r.year}</td>
                                            <td>${r.baseSalary.toFixed(2)} د.ج</td>
                                            <td>${r.totalDeductions.toFixed(2)} د.ج</td>
                                            <td>${r.totalBonuses.toFixed(2)} د.ج</td>
                                            <td>${r.netSalary.toFixed(2)} د.ج</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="print-totals">
                            <div class="print-total">
                                <h4>إجمالي الرواتب الأساسية</h4>
                                <div class="amount">${totalBase.toFixed(2)} د.ج</div>
                            </div>
                            <div class="print-total">
                                <h4>إجمالي الخصومات</h4>
                                <div class="amount">${totalDeductions.toFixed(2)} د.ج</div>
                            </div>
                            <div class="print-total">
                                <h4>إجمالي العلاوات</h4>
                                <div class="amount">${totalBonuses.toFixed(2)} د.ج</div>
                            </div>
                            <div class="print-total">
                                <h4>إجمالي صافي الرواتب</h4>
                                <div class="amount">${totalNet.toFixed(2)} د.ج</div>
                            </div>
                        </div>
                        
                        <div class="print-signature">
                            <p>توقيع المدير المالي</p>
                        </div>
                        
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            };
                        <\/script>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printReportModal.style.display = 'none';
            }
            
            // دالة عرض نافذة إدارة الميزانية
            async function showBudgetManagementModal() {
                await loadBudgetHistory();
                budgetManagementModal.style.display = 'flex';
            }
            
            // دالة حفظ تعديلات الميزانية
            async function saveBudgetChanges() {
                const transferFromLastYear = parseFloat(transferFromLastYearInput.value) || 0;
                const donationsAmount = parseFloat(donationsAmountInput.value) || 0;
                const donorName = donorNameInput.value.trim();
                
                try {
                    showMessage('جاري حفظ تعديلات الميزانية...', 'warning');
                    
                    // حساب الميزانية الجديدة
                    const newMonthlyBudget = budgetData.lastYearRemaining + transferFromLastYear + donationsAmount;
                    const newRemainingBudget = newMonthlyBudget - budgetData.paid - budgetData.expenses;
                    
                    // تحديث الميزانية في Firebase
                    await database.ref(BUDGET_FIREBASE_PATH).update({
                        monthly: newMonthlyBudget,
                        remaining: newRemainingBudget
                    });
                    
                    // تحديث البيانات المحلية
                    budgetData.monthly = newMonthlyBudget;
                    budgetData.remaining = newRemainingBudget;
                    updateBudgetDisplay();
                    
                    // تسجيل التعديلات في سجل الميزانية
                    const timestamp = new Date().toISOString();
                    const changes = [];
                    
                    if (transferFromLastYear > 0) {
                        changes.push({
                            type: 'تحويل من السنة السابقة',
                            amount: transferFromLastYear,
                            timestamp: timestamp,
                            notes: 'تم تحويل مبلغ من ميزانية السنة السابقة'
                        });
                    }
                    
                    if (donationsAmount > 0 && donorName) {
                        changes.push({
                            type: 'تبرعات المساهمين',
                            amount: donationsAmount,
                            timestamp: timestamp,
                            notes: `تبرع من ${donorName}`
                        });
                    }
                    
                    // حفظ التعديلات في سجل الميزانية
                    if (changes.length > 0) {
                        const updates = {};
                        changes.forEach(change => {
                            const newKey = database.ref(BUDGET_HISTORY_PATH).push().key;
                            updates[`${BUDGET_HISTORY_PATH}/${newKey}`] = change;
                        });
                        
                        await database.ref().update(updates);
                    }
                    
                    // إعادة تحميل سجل الميزانية
                    await loadBudgetHistory();
                    
                    showMessage('تم حفظ تعديلات الميزانية بنجاح', 'success');
                    
                    // إعادة تعيين حقول التعديل
                    transferFromLastYearInput.value = '';
                    donationsAmountInput.value = '';
                    donorNameInput.value = '';
                    
                } catch (error) {
                    console.error('Error saving budget changes:', error);
                    showMessage(`حدث خطأ أثناء حفظ تعديلات الميزانية: ${error.message}`, 'error');
                }
            }
            
            // دالة عرض رسائل للمستخدم
            function showMessage(msg, type) {
                messageDiv.textContent = msg;
                messageDiv.className = `message ${type}`;
                messageDiv.style.display = 'block';
                
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
            
            // دالة إعادة تعيين نموذج الراتب
            function resetSalaryForm() {
                teacherSelect.value = '';
                monthSelect.value = new Date().getMonth() + 1;
                yearSelect.value = new Date().getFullYear();
                baseSalaryInput.value = '';
                deductionsContainer.innerHTML = '';
                bonusesContainer.innerHTML = '';
                calculateNetSalary();
                currentEditingSalaryId = null;
                
                // إظهار زر الحفظ وإخفاء زر التعديل
                saveSalaryBtn.style.display = 'inline-flex';
                editSalaryBtn.style.display = 'none';
            }
        });
    </script>
</body>
</html>
